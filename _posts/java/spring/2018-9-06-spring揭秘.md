---
layout: post
title:  spring揭秘
date:   2019-8-16 08:00:00 +0800
categories: spring
tag: 源码
---

随手记录一下《spring揭秘》的内容，日后整理
## IOC
几个重要的接口/类 
两种容器：
* BeanFactory （基础容器）
* ApplicationContext （在BeanFactory基础上构建的较高级的容器）   

BeanFactory和ApplicationContext继承关系：   
![](/styles/images/java/BeanFactoryAndApplicationContext.png)


* BeanDefinition    
每一个Bean在容器中都会有一个BeanDefinition的实例与之相对应，该BeanDefinition的实例负责保存对象的所有必要信息，包括其对应的对象的class类型、是否是抽象类、构造方法参数以及其他属性等。   
当客户端向BeanFactory请求相应对象的时候，BeanFactory会通过这些信息为客户端返回一个完备可用的对象实例。RootBeanDefinition和ChildBeanDefinition是BeanDefinition的两个主要实现类
* BeanDefinitionRegistry (接口定义抽象了Bean的注册逻辑)
* BeanDefinitionReader (读取xml至BeanDefinition)

BeanFactory、BeanDefinition、BeanDefinitionRegistry关系：   
![](/styles/images/java/BeanDefinition.png)

BeanFactory、BeanDefinition、BeanDefinitionRegistry注册例子：   
```java
   public static void main(String[] args) {
        // 首先构造一个DefaultListableBeanFactory作为BeanDefinitionRegistry
        DefaultListableBeanFactory beanRegistry = new DefaultListableBeanFactory();
        //交给bindViaCode方法进行具体的对象注册和相关依赖管理，然后通过bindViaCode返回的BeanFactory
        BeanFactory container = (BeanFactory) bindViaCode(beanRegistry);
        FXNewsProvider newsProvider = (FXNewsProvider) container.getBean("djNewsProvider");
        newsProvider.getAndPersistNews();
    }

    public static BeanFactory bindViaCode(BeanDefinitionRegistry registry) {
        //首先针对相应的业务对象构造与其相对应的BeanDefinition
        AbstractBeanDefinition newsProvider = new RootBeanDefinition(FXNewsProvider.class, true);
        AbstractBeanDefinition newsListener = new RootBeanDefinition(DowJonesNewsListener.class, true);
        AbstractBeanDefinition newsPersister = new RootBeanDefinition(DowJonesNewsPersister.class, true);
        // 将bean定义注册到容器中
        registry.registerBeanDefinition("djNewsProvider", newsProvider);
        registry.registerBeanDefinition("djListener", newsListener);
        registry.registerBeanDefinition("djPersister", newsPersister);
        // 指定依赖关系
        // 1. 可以通过构造方法注入方式
        ConstructorArgumentValues argValues = new ConstructorArgumentValues();
        argValues.addIndexedArgumentValue(0, newsListener);
        argValues.addIndexedArgumentValue(1, newsPersister);
        newsProvider.setConstructorArgumentValues(argValues);
        // 2. 或者通过setter方法注入方式
        MutablePropertyValues propertyValues = new MutablePropertyValues();
        propertyValues.addPropertyValue(new ropertyValue("newsListener", newsListener));
        propertyValues.addPropertyValue(new PropertyValue("newPersistener", newsPersister));
        newsProvider.setPropertyValues(propertyValues);
        // 绑定完成 以BeanFactory的形式返回已经注册并绑定了所有相关业务对象的BeanDefinitionRegistry实例
        return (BeanFactory) registry;
    }
```
