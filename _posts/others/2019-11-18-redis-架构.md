---
layout: post
title:  redis开发与运维-多节点架构
date:   2019-11-18 08:00:00 +0800
categories: 
- redis开发与运维
tag: 
- redis开发与运维
---

* content
{:toc}

## 1. 数据同步原理
过程：   
![](/styles/images/other/redis15.png)   

(2) 从节点会建立一个socket套接字， 专门用于接受主节点发送的复制命令，   
如果从节点无法建立连接， 定时任务会无限重试直到连接成功或者执行slaveof no one取消复制   
(3) 发送ping命令，如果发送ping命令后， 从节点没有收到主节点的pong回复或者超时， 比如网络超时或者主节点正在阻塞无法响应命令， 从节点会断开复制连接， 下次定时任务会发起重连   
(5) 同步数据集，首次会全量同步，命令有sync和psync(>=2.8)，psync可以从某个节点开始同步

psync {runId} {offset}   返回：FULLRESYNC CONTINUE ERR

### 1. 全量复制

![](/styles/images/other/redis16.png)   

### 2. 部分复制

![](/styles/images/other/redis17.png)   

## 2. 主从
三种创建方式：
1. 在配置文件中加入slaveof {masterHost} {masterPort} 随Redis启动生效。
2. 在redis-server启动命令后加入--slaveof {masterHost} {masterPort}生效。
3. 直接使用命令： slaveof {masterHost} {masterPort}生效（也可切换至另一个主节点，会清空之前节点数据）。

断开主从： slaveof no one
从节点只读： slave-read-only yes

是否往从节点立即发送： repl-disable-tcp-nodelay no （yes会默认将40ms的内容一起发送）

拓扑：一主一从 一主多从 树状主从(从节点再发给其他从节点)

## 3. 哨兵

## 4. 集群
